# 小红卡 - 并发症管理指引生成器

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Next.js](https://img.shields.io/badge/Next.js-15-black)](https://nextjs.org/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5-blue)](https://www.typescriptlang.org/)
[![Supabase](https://img.shields.io/badge/Supabase-3FCF8E?logo=supabase&logoColor=white)](https://supabase.com/)

> 🚑 专为癌症、罕见病等多病种患者设计的并发症管理指引生成器，基于小红卡四大模块体系提供专业、全面的医疗支持。

## 🎯 项目简介

小红卡是一个基于 Next.js 15 开发的现代化医疗健康应用，旨在为癌症、罕见病、慢性病患者及其家属提供专业的并发症管理支持。通过结构化的指引生成系统和 AI 智能助手，帮助用户快速获取科学的并发症处理方案。

### ✨ 核心功能

- **🆘 指引生成器**：基于小红卡四大模块的个性化指引生成
- **🤖 AI 智能助手**：使用 z-ai-web-dev-sdk 的专业医疗咨询
- **📊 实时统计**：访问量和服务患者数的实时统计
- **📱 响应式设计**：支持移动端、平板、桌面端全设备访问
- **🔄 实时通信**：WebSocket 支持的在线用户统计和实时更新

## 🚀 快速开始

### 环境要求

- Node.js 18.0 或更高版本
- npm 或 yarn 包管理器
- Supabase 账户（用于数据库和实时功能）

### 安装步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/your-username/xiaohongka.git
   cd xiaohongka
   ```

2. **⚠️ 重要：安装依赖**
   ```bash
   # 必须先安装依赖，否则会出现 "next: command not found" 错误
   npm install
   ```

3. **环境配置**
   ```bash
   # 复制环境变量模板（如果存在）
   cp .env.example .env.local
   
   # 或者直接创建 .env 文件
   touch .env
   ```

4. **配置 Supabase**
   ```bash
   # 在 .env 文件中添加以下配置
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
   ```

5. **构建项目（可选）**
   ```bash
   # 构建生产版本
   npm run build
   ```

6. **启动应用**
   
   **开发模式（推荐用于开发）：**
   ```bash
   npm run dev
   ```
   
   **生产模式（推荐用于部署）：**
   ```bash
   # 先构建项目
   npm run build
   
   # 启动生产服务器
   npm start
   ```

7. **访问应用**
   打开浏览器访问 [http://localhost:3000](http://localhost:3000)

### 🔧 常见问题排除

#### 问题 1: "next: command not found"
**原因**：未安装项目依赖  
**解决方案**：
```bash
npm install
```

#### 问题 2: "supabaseUrl is required"
**原因**：缺少 Supabase 环境变量配置  
**解决方案**：
1. 确保项目根目录存在 `.env` 文件
2. 检查文件中是否包含正确的 Supabase 配置：
   ```bash
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
   ```

#### 问题 3: 构建失败
**解决方案**：
```bash
# 清理缓存并重新安装
rm -rf node_modules package-lock.json .next
npm install
npm run build
```

### 📋 启动检查清单

在启动项目前，请确认以下步骤已完成：

- [ ] ✅ 已安装 Node.js 18.0+
- [ ] ✅ 已运行 `npm install` 安装依赖
- [ ] ✅ 已创建并配置 `.env` 文件
- [ ] ✅ Supabase 环境变量已正确设置
- [ ] ✅ 项目构建成功（运行 `npm run build` 无错误）
- [ ] ✅ 可以正常启动开发服务器（`npm run dev`）

## 📋 功能特性

### 🆘 指引生成器

基于小红卡四大模块体系的五步式指引生成流程：

1. **并发症选择**：选择需要管理的并发症类型
2. **医疗信息填写**：填写个人基本信息和医疗历史
3. **紧急联系人添加**：添加紧急联系人和医院信息
4. **护理服务配置**：选择合适的护理服务和症状记录管理
5. **卡片预览生成**：预览和下载个性化指引卡片

### 🤖 AI 智能助手

集成了专业的医疗 AI 助手，提供：
- **并发症咨询**：专业的并发症管理建议
- **风险评估**：红绿灯系统的风险分层
- **急救指导**：紧急情况下的处理步骤
- **日常预防**：个性化的预防措施和生活指导

### 📊 实时统计系统

- **累计使用人次**：所有时间的总访问量
- **今日访问量**：当日的访问次数
- **服务患者数**：通过小红卡服务的患者数量
- **在线用户数**：当前在线的用户数量
- **统计日期**：数据统计的日期信息

### 🔄 实时通信

- **WebSocket 支持**：实时用户状态同步
- **在线状态**：显示当前在线用户数量
- **实时更新**：统计数据实时更新

## 🛠 技术栈

### 前端技术
- **框架**：Next.js 15 (App Router)
- **语言**：TypeScript 5
- **样式**：Tailwind CSS 4
- **组件库**：shadcn/ui (New York style)
- **状态管理**：Zustand + TanStack Query
- **动画**：Framer Motion
- **图标**：Lucide React

### 后端技术
- **API**：Next.js API Routes
- **数据库**：Supabase (PostgreSQL)
- **实时通信**：WebSocket / Socket.io
- **AI集成**：z-ai-web-dev-sdk

### 开发工具
- **包管理**：npm
- **代码质量**：ESLint + Prettier
- **类型检查**：TypeScript
- **构建工具**：Next.js

## 📁 项目结构

```
xiaohongka/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/               # API 路由
│   │   ├── page.tsx           # 首页
│   │   └── layout.tsx         # 根布局
│   ├── components/            # React 组件
│   │   ├── ui/                # shadcn/ui 组件
│   │   ├── GuideGenerator.tsx # 指引生成器
│   │   ├── CardPreview.tsx    # 卡片预览
│   │   ├── VisitCounter.tsx   # 访问计数器
│   │   └── AIAssistant.tsx    # AI 助手
│   ├── lib/                   # 工具库
│   │   ├── supabase.ts        # Supabase 客户端
│   │   ├── socket.ts          # WebSocket 配置
│   │   └── utils.ts           # 工具函数
│   └── types/                 # TypeScript 类型定义
├── prisma/                    # Prisma 配置
├── public/                    # 静态资源
├── docs/                      # 文档
├── .env.local                 # 环境变量
├── package.json               # 项目配置
├── tailwind.config.js         # Tailwind 配置
├── tsconfig.json              # TypeScript 配置
└── README.md                  # 项目说明
```

## 🔧 配置说明

### 环境变量

```bash
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# 可选配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_APP_NAME="小红卡"
```

### Supabase 数据库表

```sql
-- 访问统计表
CREATE TABLE visit_counters (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date TIMESTAMPTZ DEFAULT NOW(),
  visits INTEGER DEFAULT 1,
  patients INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 在线用户表
CREATE TABLE online_users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  session_id TEXT UNIQUE NOT NULL,
  user_agent TEXT,
  ip_address INET,
  last_activity TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 🚀 部署指南

### Vercel 部署（推荐）

1. **连接代码仓库**
   ```bash
   # 在 Vercel 中导入项目
   # 选择 GitHub 仓库
   ```

2. **配置环境变量**
   ```bash
   # 在 Vercel 项目设置中添加环境变量
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_key
   ```

3. **自动部署**
   - 推送代码到 GitHub 主分支
   - Vercel 会自动构建和部署

### Docker 部署

```bash
# 构建镜像
docker build -t xiaohongka .

# 运行容器
docker run -p 3000:3000 --env-file .env.local xiaohongka
```

### 传统服务器部署

```bash
# 构建项目
npm run build

# 启动生产服务器
npm start
```

## 📊 性能优化

### 前端优化
- **代码分割**：动态导入大型组件
- **图片优化**：使用 WebP 格式和懒加载
- **缓存策略**：浏览器缓存和 CDN 加速
- **字体优化**：预加载关键字体文件

### 后端优化
- **数据库索引**：为常用查询字段创建索引
- **查询优化**：避免 N+1 查询问题
- **连接池**：配置适当的连接池大小
- **CDN 加速**：静态资源通过 CDN 分发

## 🔒 安全考虑

### 数据安全
- **API 密钥管理**：使用环境变量存储敏感信息
- **数据验证**：所有输入数据进行严格验证
- **SQL 注入防护**：使用参数化查询
- **HTTPS 加密**：全站 HTTPS 支持

### 访问控制
- **CORS 配置**：限制跨域访问
- **速率限制**：防止 API 滥用
- **会话管理**：安全的会话标识符生成

### 隐私保护
- **IP 地址处理**：匿名化处理用户 IP
- **用户代理**：不存储敏感的浏览器信息
- **数据最小化**：仅收集必要的统计信息

## 🧪 测试

### 运行测试
```bash
# 运行单元测试
npm test

# 运行端到端测试
npm run test:e2e

# 代码覆盖率
npm run test:coverage
```

### 测试覆盖
- **单元测试**：组件和工具函数测试
- **集成测试**：API 接口和数据库交互测试
- **端到端测试**：完整用户流程测试
- **性能测试**：加载速度和并发处理测试

## 🤝 贡献指南

### 开发流程
1. Fork 项目
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

### 代码规范
- 使用 TypeScript 严格模式
- 遵循 ESLint 和 Prettier 规则
- 编写清晰的组件和函数文档
- 提交信息使用约定式提交规范

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 🙏 致谢

- [Next.js](https://nextjs.org/) - React 框架
- [Supabase](https://supabase.com/) - 后端即服务
- [shadcn/ui](https://ui.shadcn.com/) - UI 组件库
- [Tailwind CSS](https://tailwindcss.com/) - CSS 框架
- [Framer Motion](https://www.framer.com/motion/) - 动画库

## 📞 联系我们

- **项目主页**：[https://xiaohongka.example.com](https://xiaohongka.example.com)
- **问题反馈**：[GitHub Issues](https://github.com/your-username/xiaohongka/issues)
- **邮件联系**：[contact@xiaohongka.example.com](mailto:contact@xiaohongka.example.com)

## 📚 相关文档

- [开发日志](supabase_dev_log.md)
- [设计文档](design.md)
- [Supabase 配置](SUPABASE_COUNTER.md)
- [API 文档](docs/api.md)

---

**最后更新**：2025-06-23  
**版本**：v2.2.0  
**维护者**：Z.ai Code Team